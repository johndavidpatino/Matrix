@model List<MatrixNext.Data.Modules.TH.Ausencias.Models.AusenciaViewModel>

@{
    ViewData["Title"] = "Mis Ausencias";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Solicitudes de Ausencia</h4>
                    <a href="@Url.Action("Create", "Ausencias", new { area = "TH" })" class="btn btn-light btn-sm">
                        <i class="fas fa-plus"></i> Nueva Solicitud
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="ausenciasTable" class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo de Ausencia</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Días Laborales</th>
                                    <th>Estado</th>
                                    <th>Aprobado Por</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Count > 0)
                                {
                                    @foreach (var ausencia in Model)
                                    {
                                        <tr>
                                            <td>@ausencia.Id</td>
                                            <td>
                                                @{
                                                    string tipoAusencia = ausencia.Tipo switch
                                                    {
                                                        1 => "Vacaciones",
                                                        2 => "Incapacidad",
                                                        3 => "Permiso",
                                                        4 => "Licencia",
                                                        _ => "Otro"
                                                    };
                                                }
                                                @tipoAusencia
                                            </td>
                                            <td>@(ausencia.FechaInicio?.ToString("dd/MM/yyyy") ?? "-")</td>
                                            <td>@(ausencia.FechaFin?.ToString("dd/MM/yyyy") ?? "-")</td>
                                            <td>
                                                <span class="badge bg-info">@ausencia.DiasLaborales días</span>
                                            </td>
                                            <td>
                                                @{
                                                    string estadoClass = ausencia.Estado switch
                                                    {
                                                        0 => "bg-warning",
                                                        1 => "bg-success",
                                                        2 => "bg-danger",
                                                        _ => "bg-secondary"
                                                    };
                                                    string estadoText = ausencia.Estado switch
                                                    {
                                                        0 => "Pendiente",
                                                        1 => "Aprobado",
                                                        2 => "Rechazado",
                                                        _ => "Desconocido"
                                                    };
                                                }
                                                <span class="badge @estadoClass">@estadoText</span>
                                            </td>
                                            <td>@ausencia.AprobadoPor</td>
                                            <td>
                                                <a href="@Url.Action("Details", "Ausencias", new { id = ausencia.Id, area = "TH" })" 
                                                   class="btn btn-sm btn-info" title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-4">
                                            No tiene solicitudes de ausencia registradas
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab de Beneficios Pendientes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Beneficios Pendientes</h5>
                </div>
                <div class="card-body">
                    <div id="beneficiosPendientes">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // DataTables script
            $.getScript('https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js', function () {
                $('#ausenciasTable').DataTable({
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                    },
                    responsive: true,
                    pageLength: 10
                });
            });

            // Cargar beneficios pendientes
            cargarBeneficiosPendientes();
        });

        function cargarBeneficiosPendientes() {
            var idEmpleado = @(ViewBag.CurrentUserId ?? 0);

            $.ajax({
                url: '/TH/Ausencias/ObtenerBeneficiosPendientes/' + idEmpleado,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success && response.data && response.data.length > 0) {
                        var html = '<div class="row">';
                        response.data.forEach(function (beneficio) {
                            html += `
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">${beneficio.beneficio || 'Beneficio'}</h6>
                                            <p class="card-text">
                                                <strong>Saldo:</strong> ${beneficio.dias || 0} días
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        $('#beneficiosPendientes').html(html);
                    } else {
                        $('#beneficiosPendientes').html('<p class="text-muted">No hay beneficios pendientes</p>');
                    }
                },
                error: function () {
                    $('#beneficiosPendientes').html('<p class="text-danger">Error cargando beneficios</p>');
                }
            });
        }
    </script>
}
