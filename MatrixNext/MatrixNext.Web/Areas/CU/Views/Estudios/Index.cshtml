@model EstudiosIndexViewModel

@{
    ViewData["Title"] = "Estudios";
    var contexto = Model.Contexto;
}

<div class="container-fluid mt-4">
    @if (contexto != null)
    {
        <div class="alert alert-secondary d-flex justify-content-between align-items-center">
            <div>
                <strong>JobBook:</strong> @contexto.NumJobBook &nbsp;|&nbsp;
                <strong>Titulo:</strong> @contexto.Titulo &nbsp;|&nbsp;
                <strong>Cliente:</strong> @contexto.Cliente
            </div>
            <div>
                <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Index","Cuentas", new { area="CU"})">Cambiar JobBook</a>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Estudios de la propuesta @Model.IdPropuesta</h4>
            <button class="btn btn-primary btn-sm" id="btnNuevoEstudio" data-propuesta="@Model.IdPropuesta">Nuevo estudio</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>JobBook</th>
                            <th>Nombre</th>
                            <th>Valor</th>
                            <th>Fecha inicio</th>
                            <th>Fecha fin</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Estudios.Count == 0)
                        {
                            <tr><td colspan="7" class="text-muted">Sin estudios</td></tr>
                        }
                        else
                        {
                            foreach (var item in Model.Estudios)
                            {
                                <tr data-id="@item.Id">
                                    <td>@item.Id</td>
                                    <td>@item.JobBook</td>
                                    <td>@item.Nombre</td>
                                    <td>@item.Valor</td>
                                    <td>@item.FechaInicio?.ToString("yyyy-MM-dd")</td>
                                    <td>@item.FechaTerminacion?.ToString("yyyy-MM-dd")</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary btn-editar" data-id="@item.Id">Editar</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modalEstudioContainer"></div>

@section Scripts {
    <script>
        (function () {
            const modalContainer = document.getElementById('modalEstudioContainer');
            const btnNuevo = document.getElementById('btnNuevoEstudio');

            btnNuevo.addEventListener('click', () => {
                const propuestaId = btnNuevo.getAttribute('data-propuesta');
                if (!propuestaId) {
                    alert('No hay propuesta seleccionada.');
                    return;
                }
                abrirModal(`@Url.Action("Crear", "Estudios", new { area = "CU" })?idPropuesta=${propuestaId}`);
            });

            document.querySelectorAll('.btn-editar').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    abrirModal(`@Url.Action("Editar", "Estudios", new { area = "CU" })/${id}`);
                });
            });

            function abrirModal(url) {
                fetch(url)
                    .then(r => r.text())
                    .then(html => {
                        modalContainer.innerHTML = html;
                        const modalEl = document.getElementById('estudioModal');
                        const modal = new bootstrap.Modal(modalEl);
                        wireForm(modal);
                        modal.show();
                    })
                    .catch(err => {
                        console.error(err);
                        alert('No fue posible cargar el formulario');
                    });
            }

            function wireForm(modal) {
                const form = document.getElementById('estudioForm');
                if (!form) return;
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    fetch('@Url.Action("Guardar", "Estudios", new { area = "CU" })', {
                        method: 'POST',
                        body: formData
                    })
                        .then(r => r.json())
                        .then(res => {
                            alert(res.message);
                            if (res.success) {
                                modal.hide();
                                window.location.reload();
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('No fue posible guardar el estudio');
                        });
                });
            }
        })();
    </script>
}
